<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sistema de Gabaritos</title>
  <link rel="icon" href="https://i.ibb.co/JFKTr9sc/logo.png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; margin: 0; padding: 15px; color: #374151; }
    .container { max-width: 550px; margin: 10px auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
    
    .header-logo { text-align: center; margin-bottom: 20px; }
    .header-logo img { max-height: 85px; width: auto; object-fit: contain; }

    h2 { text-align: center; color: #111827; margin-bottom: 25px; margin-top: 0; font-size: 22px; }
    h3 { color: #2563eb; text-align: center; margin-bottom: 20px; font-size: 16px; }
    .hidden { display: none !important; }
    .form-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: #1f2937; }
    
    input[type="text"] { 
      width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; box-sizing: border-box; 
      font-size: 14px; transition: border-color 0.2s; background-color: #ffffff; color: #111827;
    }
    input[type="text"]:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
    
    .grupo-titulo { font-size: 12px; font-weight: 700; color: #6b7280; text-transform: uppercase; margin: 15px 0 8px 0; border-bottom: 1px solid #e5e7eb; padding-bottom: 4px; }
    .grid-turmas { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .btn-turma { 
      background-color: #f8fafc; border: 1px solid #cbd5e1; color: #334155; 
      padding: 10px; border-radius: 6px; font-size: 13px; font-weight: 500; 
      cursor: pointer; text-align: center; transition: all 0.2s;
    }
    .btn-turma:hover { background-color: #e2e8f0; border-color: #94a3b8; }

    .btn-disciplina { 
      display: flex; justify-content: space-between; align-items: center; 
      width: 100%; background: #ffffff; border: 1px solid #cbd5e1; 
      padding: 12px 15px; border-radius: 8px; margin-bottom: 8px; 
      cursor: pointer; transition: all 0.2s; box-sizing: border-box;
    }
    .btn-disciplina:hover { border-color: #94a3b8; background: #f8fafc; }
    .disc-nome { font-size: 14px; font-weight: 600; color: #1e293b; }
    
    .badge { font-size: 11px; font-weight: 700; padding: 4px 8px; border-radius: 12px; letter-spacing: 0.5px; }
    .badge-pendente { background-color: #ffedd5; color: #c2410c; border: 1px solid #fed7aa; } 
    .badge-enviado { background-color: #d1fae5; color: #15803d; border: 1px solid #a7f3d0; } 

    .selecao-resumo { 
      display: flex; justify-content: space-between; align-items: center; 
      background: #eff6ff; border: 1px solid #bfdbfe; padding: 10px 15px; 
      border-radius: 8px; margin-bottom: 15px; font-size: 13px;
    }
    .btn-alterar { background: none; border: none; color: #2563eb; font-weight: 600; font-size: 12px; cursor: pointer; text-decoration: underline; padding: 0; }

    .btn-main { width: 100%; padding: 14px; background-color: #2563eb; color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; }
    .btn-main:hover { background-color: #1d4ed8; }
    
    .btn-success { background-color: #10b981; width: 100%; padding: 14px; color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; margin-top: 15px; cursor: pointer;}
    .btn-success:hover { background-color: #059669; }
    
    .btn-warning { background-color: #f59e0b; width: 100%; padding: 14px; color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; margin-top: 15px; cursor: pointer;}
    .btn-warning:hover { background-color: #d97706; }

    .btn-gray { background-color: #6b7280; width: 100%; padding: 14px; color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; margin-top: 10px; cursor: pointer;}
    .btn-gray:hover { background-color: #4b5563; }

    .btn-red { background-color: #ef4444; width: 100%; padding: 14px; color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; margin-top: 10px; cursor: pointer;}
    .btn-red:hover { background-color: #dc2626; }

    .questao { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; padding: 10px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0; }
    .questao label { margin: 0; width: 35%; font-weight: 600; font-size: 14px; }
    .questao select { width: 60%; padding: 10px; font-size: 14px; border: 1px solid #cbd5e1; border-radius: 6px; }
    
    .questao select:disabled { background-color: #f1f5f9; color: #94a3b8; cursor: not-allowed; border-color: #e2e8f0; opacity: 1; }
    
    .msg { text-align: center; font-weight: 600; margin-top: 15px; font-size: 14px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header-logo">
      <img src="https://i.ibb.co/JFKTr9sc/logo.png" alt="Logotipo da Instituição">
    </div>

    <h2>Sistema de Gabaritos</h2>
    
    <div id="login-section">
      <div class="form-group">
        <label for="masp">Digite seu MASP:</label>
        <input type="text" id="masp" autocomplete="off" placeholder="Ex: 12345678">
      </div>
      <button class="btn-main" onclick="fazerLogin()">Entrar no Sistema</button>
      <div id="login-msg" class="msg"></div>
    </div>

    <div id="main-section" class="hidden">
      <h3 id="welcome-msg"></h3>
      
      <div id="step-turmas">
        <label>Selecione a Turma:</label>
        <div id="turmas-container"><em style="font-size: 13px; color:#6b7280;">Carregando turmas...</em></div>
      </div>
      
      <div id="step-disciplinas" class="hidden">
        <div class="selecao-resumo">
          <div>Turma: <strong id="lbl-turma-selecionada"></strong></div>
          <button class="btn-alterar" onclick="voltarParaTurmas()">Trocar Turma</button>
        </div>
        <label>Selecione a Disciplina:</label>
        <div id="disciplinas-container"></div>
      </div>

      <div id="step-gabarito" class="hidden">
        <div class="selecao-resumo" style="background: #f0fdf4; border-color: #bbf7d0;">
          <div>Disciplina: <strong id="lbl-disciplina-selecionada"></strong></div>
          <button class="btn-alterar" onclick="voltarParaDisciplinas()" style="color: #15803d;">Sair da Disciplina</button>
        </div>
        
        <h4 style="margin-top: 10px; margin-bottom: 15px; font-size: 15px; color: #1f2937;">Preencha o Gabarito:</h4>
        <div id="questoes-container"></div>
        
        <button id="btn-salvar" class="btn-success" onclick="salvar()">Salvar Gabarito</button>
        <button id="btn-limpar" class="btn-gray" onclick="limparRespostas()">Limpar Preenchimento</button>
        <button id="btn-editar" class="btn-warning hidden" onclick="habilitarEdicao()">Editar Respostas</button>
        <button id="btn-sair" class="btn-red hidden" onclick="sairSistema()">Sair do Sistema</button>
        
        <div id="save-msg" class="msg"></div>
      </div>

    </div>
  </div>

  <script>
    // IMPORTANTE: Mantenha sua URL do Web App do Google Apps Script aqui!
    const API_URL = "https://script.google.com/macros/s/AKfycbwQ9lhzFT7w5SrZZWVTy4RTlkUxGCHiALLWFKDvSuCy1HqL3NpOrGvMDTvcwNSKMbZS/exec"; 
    
    let questoesAtuais = [];
    let isSaved = false;
    let turmaAtual = "";
    let disciplinaAtual = "";
    let statusAtual = ""; 

    // --- CONTROLE DE HISTÓRICO (BOTÃO VOLTAR DO CELULAR) ---
    window.onload = function() {
      window.history.replaceState({ step: 'login' }, '');
    };

    window.onpopstate = function(event) {
      const step = event.state ? event.state.step : 'login';
      
      if (step === 'login') {
        if (!document.getElementById('main-section').classList.contains('hidden')) {
           // O usuário tentou voltar a partir da tela principal (Turmas)
           if (confirm("Deseja realmente sair do sistema?")) {
             window.location.reload(); // Recarrega a página para limpar tudo
           } else {
             window.history.pushState({ step: 'turmas' }, ''); // Mantém na tela de turmas
           }
        }
      } 
      else if (step === 'turmas') {
        mostrarStepTurmas();
      } 
      else if (step === 'disciplinas') {
        // Verifica se estava no gabarito e tem edições pendentes
        if (!document.getElementById('step-gabarito').classList.contains('hidden')) {
          if (!isSaved && !document.getElementById('btn-salvar').classList.contains('hidden')) {
            if (!confirm("Atenção: Você tem alterações que ainda não foram salvas!\n\nTem certeza que deseja sair e perder essas alterações?")) {
              window.history.pushState({ step: 'gabarito' }, ''); // Mantém no gabarito
              return;
            }
          }
        }
        mostrarStepDisciplinas();
      }
      else if (step === 'gabarito') {
        mostrarStepGabarito();
      }
    };

    // --- FUNÇÕES DE EXIBIÇÃO DE TELAS ---
    function mostrarStepTurmas() {
      document.getElementById('main-section').classList.remove('hidden');
      document.getElementById('login-section').classList.add('hidden');
      document.getElementById('step-turmas').classList.remove('hidden');
      document.getElementById('step-disciplinas').classList.add('hidden');
      document.getElementById('step-gabarito').classList.add('hidden');
    }

    function mostrarStepDisciplinas() {
      document.getElementById('main-section').classList.remove('hidden');
      document.getElementById('login-section').classList.add('hidden');
      document.getElementById('step-turmas').classList.add('hidden');
      document.getElementById('step-disciplinas').classList.remove('hidden');
      document.getElementById('step-gabarito').classList.add('hidden');
      document.getElementById('save-msg').innerText = ''; 
    }

    function mostrarStepGabarito() {
      document.getElementById('main-section').classList.remove('hidden');
      document.getElementById('login-section').classList.add('hidden');
      document.getElementById('step-turmas').classList.add('hidden');
      document.getElementById('step-disciplinas').classList.add('hidden');
      document.getElementById('step-gabarito').classList.remove('hidden');
    }

    // --- FUNÇÕES DO SISTEMA ---
    async function apiCall(action, data) {
      const response = await fetch(API_URL + "?action=" + action, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(data)
      });
      return await response.json();
    }

    async function fazerLogin() {
      var masp = document.getElementById('masp').value;
      if (!masp) { alert('Por favor, informe o MASP.'); return; }
      
      var msgBox = document.getElementById('login-msg');
      msgBox.innerText = "Autenticando..."; msgBox.style.color = "#3b82f6";

      try {
        var res = await apiCall("login", { masp: masp });
        if (res.sucesso) {
          document.getElementById('welcome-msg').innerText = "Olá, " + res.nome;
          window.history.pushState({ step: 'turmas' }, '');
          mostrarStepTurmas();
          carregarTurmas();
        } else {
          msgBox.innerText = res.erro; msgBox.style.color = "#ef4444";
        }
      } catch (error) {
        msgBox.innerText = "Erro de conexão. Verifique sua internet."; msgBox.style.color = "#ef4444";
      }
    }

    function classificarTurma(nome) {
      var n = nome.toUpperCase();
      if (n.includes("ANO")) return "FUNDAMENTAL";
      if (n.includes("REG - DIURNO") || n.includes("TEC - DIURNO")) return "REGULAR DIURNO";
      if (n.includes("REG - NOTURNO (SEDE)")) return "REGULAR NOTURNO (SEDE)";
      if (n.includes("REG - NOTURNO (MORADA)")) return "REGULAR NOTURNO (MORADA)";
      if (n.includes("EJA - NOTURNO (SEDE)")) return "EJA NOTURNO (SEDE)";
      if (n.includes("EJA - NOTURNO (MORADA)")) return "EJA NOTURNO (MORADA)";
      return "OUTRAS TURMAS";
    }

    async function carregarTurmas() {
      var turmas = await apiCall("getTurmas", {});
      var container = document.getElementById('turmas-container');
      container.innerHTML = '';
      
      var grupos = {};
      turmas.forEach(t => {
        var grupo = classificarTurma(t);
        if(!grupos[grupo]) grupos[grupo] = [];
        grupos[grupo].push(t);
      });

      var ordemGrupos = [
        "FUNDAMENTAL", "REGULAR DIURNO", "REGULAR NOTURNO (SEDE)", 
        "REGULAR NOTURNO (MORADA)", "EJA NOTURNO (SEDE)", "EJA NOTURNO (MORADA)", "OUTRAS TURMAS"
      ];

      ordemGrupos.forEach(nomeGrupo => {
        if(grupos[nomeGrupo] && grupos[nomeGrupo].length > 0) {
          var titulo = document.createElement('div');
          titulo.className = 'grupo-titulo';
          titulo.innerText = nomeGrupo;
          container.appendChild(titulo);

          var grid = document.createElement('div');
          grid.className = 'grid-turmas';
          
          grupos[nomeGrupo].forEach(turmaNome => {
            var btn = document.createElement('button');
            btn.className = 'btn-turma';
            btn.innerText = turmaNome;
            btn.onclick = () => selecionarTurma(turmaNome);
            grid.appendChild(btn);
          });
          
          container.appendChild(grid);
        }
      });
    }

    function selecionarTurma(nomeTurma) {
      turmaAtual = nomeTurma;
      document.getElementById('lbl-turma-selecionada').innerText = nomeTurma;
      window.history.pushState({ step: 'disciplinas' }, '');
      mostrarStepDisciplinas();
      carregarDisciplinas();
    }

    // Os botões de voltar agora chamam o histórico do navegador para não duplicar regras
    function voltarParaTurmas() {
      window.history.back();
    }

    function voltarParaDisciplinas() {
      window.history.back();
    }

    async function carregarDisciplinas() {
      var container = document.getElementById('disciplinas-container');
      container.innerHTML = '<em style="font-size: 13px; color:#6b7280;">Buscando disciplinas...</em>';

      var disciplinas = await apiCall("getDisciplinas", { turma: turmaAtual });
      container.innerHTML = '';
      
      disciplinas.forEach(d => {
        var btn = document.createElement('button');
        btn.className = 'btn-disciplina';
        btn.onclick = () => selecionarDisciplina(d.nome, d.status);
        
        var spanNome = document.createElement('span');
        spanNome.className = 'disc-nome';
        spanNome.innerText = d.nome;

        var spanStatus = document.createElement('span');
        if(d.status === "Enviado") {
          spanStatus.className = 'badge badge-enviado';
          spanStatus.innerText = 'ENVIADO';
        } else {
          spanStatus.className = 'badge badge-pendente';
          spanStatus.innerText = 'PENDENTE';
        }

        btn.appendChild(spanNome);
        btn.appendChild(spanStatus);
        container.appendChild(btn);
      });
    }

    function selecionarDisciplina(nomeDisciplina, status) {
      if (status === "Enviado") {
        if (!confirm("Esta disciplina já possui um gabarito cadastrado!\n\nDeseja visualizar/editar os registros existentes?")) {
          return;
        }
      }
      
      disciplinaAtual = nomeDisciplina;
      statusAtual = status; 
      
      document.getElementById('lbl-disciplina-selecionada').innerText = nomeDisciplina;
      window.history.pushState({ step: 'gabarito' }, '');
      mostrarStepGabarito();
      
      carregarQuestoes();
    }

    async function carregarQuestoes() {
      var qContainer = document.getElementById('questoes-container');
      
      document.getElementById('save-msg').innerText = '';
      qContainer.innerHTML = '<em style="color:#6b7280; font-size: 13px;">Carregando o formulário...</em>';

      var questoes = await apiCall("getQuestoes", { turma: turmaAtual, disciplina: disciplinaAtual });
      questoesAtuais = questoes;
      qContainer.innerHTML = '';
      
      questoes.forEach(q => {
        var div = document.createElement('div'); div.className = 'questao';
        var label = document.createElement('label'); label.innerText = 'Questão ' + q.qNo + ': ';
        var select = document.createElement('select'); select.id = 'q_' + q.row;
        
        ['-', 'A', 'B', 'C', 'D'].forEach(o => {
          var option = document.createElement('option');
          option.value = o === '-' ? '' : o; option.innerText = o;
          select.appendChild(option);
        });

        if(q.respostaAtual && ['A', 'B', 'C', 'D'].includes(q.respostaAtual)) {
          select.value = q.respostaAtual; 
          select.style.borderLeft = "4px solid #10b981"; 
        }

        if(statusAtual === "Enviado") {
          select.disabled = true;
        }

        div.appendChild(label); div.appendChild(select); qContainer.appendChild(div);
      });

      if(statusAtual === "Enviado") {
        document.getElementById('btn-salvar').classList.add('hidden');
        document.getElementById('btn-limpar').classList.add('hidden'); 
        document.getElementById('btn-editar').classList.remove('hidden');
        document.getElementById('btn-sair').classList.remove('hidden');
        isSaved = true; 
      } else {
        document.getElementById('btn-salvar').classList.remove('hidden');
        document.getElementById('btn-limpar').classList.remove('hidden'); 
        document.getElementById('btn-editar').classList.add('hidden');
        document.getElementById('btn-sair').classList.add('hidden');
        isSaved = false;
      }
    }

    function limparRespostas() {
      if (confirm("Tem certeza que deseja limpar todas as respostas preenchidas?\n\nEsta ação apagará o preenchimento atual na tela.")) {
        questoesAtuais.forEach(q => {
          var select = document.getElementById('q_' + q.row);
          select.value = '';
          select.style.borderLeft = "1px solid #cbd5e1"; 
        });
        var msgBox = document.getElementById('save-msg');
        msgBox.innerText = "Respostas limpas. Você pode iniciar um novo preenchimento.";
        msgBox.style.color = "#6b7280";
      }
    }

    function habilitarEdicao() {
      questoesAtuais.forEach(q => {
        document.getElementById('q_' + q.row).disabled = false;
      });
      
      document.getElementById('btn-editar').classList.add('hidden');
      document.getElementById('btn-salvar').classList.remove('hidden');
      document.getElementById('btn-limpar').classList.remove('hidden'); 
      
      var msgBox = document.getElementById('save-msg');
      msgBox.innerText = "Modo de edição ativado. Altere as respostas e clique em Salvar.";
      msgBox.style.color = "#d97706"; 
      
      isSaved = false; 
    }

    async function salvar() {
      var respostas = [];
      var todasPreenchidas = true;

      questoesAtuais.forEach(q => {
        var val = document.getElementById('q_' + q.row).value;
        if (val) {
          respostas.push({ row: q.row, valor: val });
        } else {
          todasPreenchidas = false;
        }
      });

      var msgBox = document.getElementById('save-msg');

      if (!todasPreenchidas) { 
        msgBox.innerText = "Atenção: Todas as questões devem ser preenchidas antes de salvar!"; 
        msgBox.style.color = "#ef4444"; 
        return; 
      }

      msgBox.innerText = "Salvando gabarito... Por favor, aguarde."; msgBox.style.color = "#3b82f6";

      var res = await apiCall("salvar", { turma: turmaAtual, respostas: respostas });
      if (res.sucesso) {
        msgBox.innerText = "Gabarito salvo com sucesso!"; msgBox.style.color = "#10b981";
        
        isSaved = true; 
        statusAtual = "Enviado"; 
        
        questoesAtuais.forEach(q => {
          document.getElementById('q_' + q.row).disabled = true;
        });

        document.getElementById('btn-salvar').classList.add('hidden');
        document.getElementById('btn-limpar').classList.add('hidden'); 
        document.getElementById('btn-editar').classList.remove('hidden');
        document.getElementById('btn-sair').classList.remove('hidden');
        
        carregarDisciplinas(); 

      } else {
        msgBox.innerText = "Erro ao salvar: " + res.erro; msgBox.style.color = "#ef4444";
      }
    }

    function sairSistema() {
      if (confirm("Deseja realmente sair do sistema?")) {
        window.location.reload(); 
      }
    }
  </script>
</body>
</html>
